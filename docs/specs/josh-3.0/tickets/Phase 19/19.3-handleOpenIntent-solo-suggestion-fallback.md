# Ticket 19.3 — handleOpenIntent: Solo Suggestion Fallback (M)

## Role

Principal Systems Architect & Full-Stack Engineer (Messaging Handlers + Eligibility Gates)

## Context

Phase 19 introduces intent-first routing. When intent is `OPEN_INTENT`, the router dispatches to `handleOpenIntent`. This handler must default to a solo activity suggestion (always available), while offering LinkUp and Plan Circle paths only when the user is eligible.

JOSH must not generate its own activity copy. Suggestions must use canonical catalog copy from `activity_catalog.short_description`.

## Goals

- Implement `handleOpenIntent(userId, message, session)` as the `OPEN_INTENT` handler.
- Gate LinkUp and Plan Circle offers using `evaluateEligibility`.
- Always provide a solo fallback suggestion via `suggestSoloActivity(userId)`.
- Transition session to `awaiting_social_choice` after sending the suggestion.

## Non-Goals

- Do not implement `handlePlanSocialChoice` (Ticket 19.4).
- Do not change router wiring (Ticket 19.2 already handled it).
- Do not add/modify Supabase schema or migrations.
- Do not change onboarding/QStash behavior.
- Do not invent activity copy or new activity content.

---

## Requirements

### 1) Handler: handleOpenIntent

Create:

- `packages/messaging/src/handlers/handle-open-intent.ts`

Implement:

- `handleOpenIntent(userId: string, message: string, session: ConversationSession): Promise<void>`

Behavior (in this order):

1. Evaluate LinkUp eligibility
   - Call: `evaluateEligibility({ userId, action_type: 'can_initiate_linkup' })`
   - If eligible:
     - Hand off to the existing LinkUp initiation flow (do not reimplement).
     - The user should receive a LinkUp offer/next step consistent with current LinkUp flow.
     - The handler may return after handoff if the LinkUp flow takes over.

2. If not LinkUp-eligible: check whether the user has any contact circle entries
   - Determine whether `contact_circle` has entries for the user.
   - If there are entries:
     - Call: `evaluateEligibility({ userId, action_type: 'can_initiate_named_plan' })`
     - If eligible:
       - Offer the Plan Circle path (handoff to existing named plan flow or the existing Plan Circle entrypoint, without reimplementing).
       - If that flow does not fully take over, continue to solo fallback.

3. Solo fallback (always available)
   - Call: `suggestSoloActivity(userId)`
   - Send a suggestion message based on the returned activity.
   - The suggestion message must use `activity_catalog.short_description`.
   - JOSH must not generate its own activity copy.

4. Session transition
   - After a solo suggestion is sent, set session mode to `awaiting_social_choice`.

Notes:

- The handler must not call an LLM for this ticket unless an existing downstream flow already does so.
- Keep the handler deterministic and side-effect minimal outside messaging + session state updates.

---

### 2) Suggestion Engine: suggestSoloActivity

Create:

- `packages/core/src/suggestions/suggest-solo-activity.ts`

Implement:

- `suggestSoloActivity(userId: string): Promise<ActivityCatalogEntry>`

Selection rules:

- Query `activity_catalog` and return a single activity that matches:
  - The user’s `regional_availability`
  - The user’s motive weights
  - The user’s schedule preferences
- The function returns one activity, not a list.

Output requirements:

- Must return an activity with `short_description` populated (used for outbound message).
- Must not generate new copy.

---

## Unit Tests

### 1) Handler routing gates

Add unit tests covering:

- LinkUp eligible
  - `evaluateEligibility({ action_type: 'can_initiate_linkup' })` returns eligible
  - Expect handoff to LinkUp initiation flow
  - Ensure solo suggestion fallback is not used in this case (unless required by existing flow semantics)

- Not LinkUp-eligible, has contact circle entries, named plan eligible
  - LinkUp ineligible
  - `contact_circle` has entries
  - `evaluateEligibility({ action_type: 'can_initiate_named_plan' })` eligible
  - Expect Plan Circle offer/handoff path is invoked
  - Ensure solo fallback behavior remains correct if the Plan Circle path does not take over

- Not eligible for LinkUp and no named plan path available
  - LinkUp ineligible
  - Either no contact circle entries, or named plan ineligible
  - Expect solo suggestion sent via `suggestSoloActivity()`

### 2) suggestSoloActivity selection correctness

- Unit test: returned activity matches user `regional_availability`.

### 3) Session transition

- Unit test: after solo suggestion is sent, session transitions to `awaiting_social_choice`.

Test constraints:

- Deterministic.
- No network calls.
- Prefer dependency injection/mocking for DB access, eligibility checks, and message sending.

---

## Verification

- A user with no subscription receives a solo activity suggestion.
- A user with an active subscription in an open region receives a LinkUp offer.
- Suggested activity `regional_availability` matches the user’s location/availability.
- Session mode is `awaiting_social_choice` after the handler completes (when a solo suggestion is sent).

---

## Deliverables

- `packages/messaging/src/handlers/handle-open-intent.ts`
- `packages/core/src/suggestions/suggest-solo-activity.ts`
- Unit tests:
  - Eligibility gate routing (LinkUp eligible / named plan only / solo only)
  - `suggestSoloActivity()` regional availability match
  - Session transitions to `awaiting_social_choice` after solo suggestion
- No migrations
- No new env vars
