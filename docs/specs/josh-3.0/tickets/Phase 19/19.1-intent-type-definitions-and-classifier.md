# Ticket 19.1 — Intent Type Definitions And Classifier (M)

## Role

Principal Systems Architect & Full-Stack Engineer (Conversation Routing + Intent Classification)

## Context

Phase 19 replaces mode-only routing with intent-first dispatch. Ticket 19.1 establishes the canonical 3.0 intent taxonomy and implements the intent classifier used by the router in Ticket 19.2.

This ticket must implement deterministic classification paths that do not require an LLM for:

- Unknown-number invitation responses
- Session-mode “awaiting_social_choice” messages
- Session-mode “interviewing” messages
- System command keywords (STOP/HELP/etc.)

The LLM is used only for disambiguating `OPEN_INTENT` vs `NAMED_PLAN_REQUEST` when the message is ambiguous.

## Goals

1. Define canonical 3.0 intent types in a single shared file location.
2. Implement `classifyIntent(message, session)` returning `{ intent, confidence }` with required precedence rules.
3. Add unit tests that lock all deterministic classification paths and verify that interview/social-choice mode paths avoid LLM calls.

## Non-Goals

- Do not update production router wiring in this ticket (that is Ticket 19.2).
- Do not add or modify Supabase schema/migrations.
- Do not change onboarding/QStash.
- Do not implement handler logic (Tickets 19.3+).

---

## Requirements (Must Match Build Plan)

### 1) Canonical Intent Types

Create:

- `packages/messaging/src/intents/intent-types.ts`

With the following TypeScript union:

- `OPEN_INTENT` — user wants to do something, unspecified
- `NAMED_PLAN_REQUEST` — user references a specific person or group
- `PLAN_SOCIAL_CHOICE` — user is responding to an activity suggestion in `awaiting_social_choice` mode
- `CONTACT_INVITE_RESPONSE` — unknown number with a pending invitation
- `POST_ACTIVITY_CHECKIN` — post-activity follow-up response
- `INTERVIEW_ANSWER` — response within an active interview session
- `INTERVIEW_ANSWER_ABBREVIATED` — response within an abbreviated interview
- `SYSTEM_COMMAND` — STOP, HELP, or other system keywords (existing)

Export:

- `IntentType` (the union)
- Any lightweight helper types needed by classifier/tests (avoid over-design)

### 2) Classifier Contract

Create:

- `packages/messaging/src/intents/intent-classifier.ts`

Implement:

- `classifyIntent(message: string, session: ConversationSession): IntentClassification`

Where:

- `IntentClassification = { intent: IntentType; confidence: number }`

Rules:

- `confidence` must be in the range `[0, 1]`.
- Classifier must be deterministic for identical `(message, session)` inputs, except where it intentionally calls the LLM for ambiguity resolution between `OPEN_INTENT` and `NAMED_PLAN_REQUEST`.
- “System keywords” precedence and parsing should remain consistent with the existing STOP/HELP behavior already used in the system.

### 3) Precedence And Deterministic Paths (No LLM)

The classifier must satisfy these precedence rules:

#### A) Pending invitation short-circuit (Runs before all other classification)

A message from a phone number with:

- no user record, AND
- a pending `contact_invitations` row

Must classify as:

- `CONTACT_INVITE_RESPONSE`

This check must run before all other classification logic and must be true regardless of message content.

Notes:

- The build plan later wires invitation lookup into the router before user resolution in Ticket 19.2; however, 19.1 must still implement the classifier rule so that once session context indicates the invite condition, classification is forced.

#### B) `awaiting_social_choice` mode (No LLM)

If the session is in mode `awaiting_social_choice` and the message is not a system keyword, classify as:

- `PLAN_SOCIAL_CHOICE`

Without LLM involvement.

#### C) `interviewing` mode (No LLM)

If the session is in mode `interviewing` and the message is not a system keyword, classify as:

- `INTERVIEW_ANSWER`

Without LLM involvement.

#### D) System keywords (Existing behavior)

STOP/HELP (and other system keywords already supported) must classify as:

- `SYSTEM_COMMAND`

This must be available from any mode/state.

### 4) LLM Use (Restricted)

LLM is used only for:

- Disambiguating `OPEN_INTENT` vs `NAMED_PLAN_REQUEST`

And only when the message is ambiguous.

Implementation notes:

- The classifier should be structured so that deterministic paths return early before any LLM code is reached.
- Unit tests must prove that deterministic paths do not call the LLM.

---

## Suggested Implementation Outline (Concrete)

In `intent-classifier.ts`:

1. Normalize `message` (trim; keep original for downstream; do not mutate session).
2. If message matches system keywords => `{ intent: 'SYSTEM_COMMAND', confidence: 1 }`.
3. If session indicates “unknown number + pending invitation” => `{ intent: 'CONTACT_INVITE_RESPONSE', confidence: 1 }`.
4. If session.mode === `awaiting_social_choice` => `{ intent: 'PLAN_SOCIAL_CHOICE', confidence: 1 }`.
5. If session.mode === `interviewing` => `{ intent: 'INTERVIEW_ANSWER', confidence: 1 }`.
6. Otherwise, attempt to classify:
   - If clearly references a specific person/group => `NAMED_PLAN_REQUEST` (confidence high).
   - If clearly open-ended => `OPEN_INTENT` (confidence high).
   - If ambiguous between those two => call LLM and map to one of the two.
7. If classifier cannot decide (should be rare given LLM fallback), return `OPEN_INTENT` with low confidence or an explicit conservative default consistent with Phase 19 design.

---

## Tests

### Required Unit Tests

Add tests that validate:

Deterministic paths:

1. Unknown number with pending invitation => `CONTACT_INVITE_RESPONSE` regardless of message content.
2. `awaiting_social_choice` mode => `PLAN_SOCIAL_CHOICE` without LLM call.
3. `interviewing` mode => `INTERVIEW_ANSWER` without LLM call.
4. System keyword STOP/HELP => `SYSTEM_COMMAND` from any mode.

LLM gating: 5. Ambiguous message triggers LLM path only for deciding `OPEN_INTENT` vs `NAMED_PLAN_REQUEST`. 6. Clear messages do not call LLM.

### Verification Cases (Must Pass)

- "I want to do something this weekend" → `OPEN_INTENT`
- "I want to go hiking with Sarah" → `NAMED_PLAN_REQUEST`
- Message from unknown number with pending invitation → `CONTACT_INVITE_RESPONSE` regardless of message content
- Message from user in `awaiting_social_choice` → `PLAN_SOCIAL_CHOICE` without LLM call
- Message from user in `interviewing` → `INTERVIEW_ANSWER` without LLM call

### Test Constraints

- No network calls.
- Deterministic.
- Prefer explicit asserts over snapshots.
- If mocking/stubbing LLM helper functions, verify call counts (0 vs 1) to enforce “no LLM” paths.

---

## Deliverables Checklist

- `packages/messaging/src/intents/intent-types.ts`
- `packages/messaging/src/intents/intent-classifier.ts`
- Unit tests covering deterministic paths and LLM gating
- Lint/typecheck/build pass
- `pnpm test` may only fail if it matches the known baseline failure on `main` (do not introduce new failing tests)

## Notes For Ticket 19.2 Compatibility

Ticket 19.2 will:

- Run STOP/HELP precedence first in the router.
- Look up `contact_invitations` by `phone_hash` before user resolution.
- Use `classifyIntent()` for routing.

So this ticket must keep the classifier contract stable and minimal, and should not add extra side effects or router coupling.
