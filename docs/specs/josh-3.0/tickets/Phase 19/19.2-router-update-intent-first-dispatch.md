# Ticket 19.2 — Router Update: Intent-First Dispatch (M)

## Role

Principal Systems Architect & Full-Stack Engineer (Conversation Routing + Messaging Edge)

## Context

Phase 19 replaces mode-only routing with intent-first dispatch. Ticket 19.1 introduced canonical intent types + `classifyIntent()`. This ticket updates the conversation router to:

1. Preserve STOP/HELP precedence behavior
2. Look up pending invitations by `phone_hash` _before_ user resolution
3. Dispatch based on intent type into the correct handler or existing engines
4. Preserve backward-compatible mode-based routing for session modes not covered by new intents
5. Update Twilio inbound to reflect the new dispatch order

This ticket is router-only wiring. It must not implement the new handlers (Tickets 19.3+).

## Goals

- Update router dispatch order to intent-first routing.
- Add invitation lookup short-circuit before user resolution.
- Ensure STOP/HELP bypasses intent classification.
- Ensure interview-mode routing continues to work (and does not regress).
- Add unit tests for invite short-circuit and STOP/HELP precedence.

## Non-Goals

- Do not implement handler business logic (19.3+).
- Do not add/modify Supabase schema or migrations.
- Do not change onboarding/QStash behavior.
- Do not change eligibility rules or enforcement.

---

## Requirements

### 1) Update Router: Intent-First Dispatch

Update:

- `packages/messaging/conversation-router.ts`

Routing order must be:

1. STOP/HELP precedence check first (unchanged)
   - If STOP/HELP/system keyword is detected, route to existing system command handlers and return.
   - The intent classifier must NOT run for system commands.

2. Invitation lookup by `phone_hash` before user resolution
   - Look up `contact_invitations` by `phone_hash` for the inbound number.
   - If there is a pending invitation, short-circuit routing to `CONTACT_INVITE_RESPONSE` before attempting user lookup.
   - This short-circuit must occur regardless of message content.

3. Run `classifyIntent()` for all remaining messages (post STOP/HELP, post invite short-circuit), unless an existing session mode hard-routes the message (see item 5 below).

4. Dispatch based on intent type:
   - `CONTACT_INVITE_RESPONSE` → `handleContactInviteResponse`
   - `POST_ACTIVITY_CHECKIN` → `handlePostActivityCheckin`
   - `OPEN_INTENT` → `handleOpenIntent`
   - `NAMED_PLAN_REQUEST` → `handleNamedPlanRequest`
   - `PLAN_SOCIAL_CHOICE` → `handlePlanSocialChoice`
   - `INTERVIEW_ANSWER` → existing interview engine
   - `INTERVIEW_ANSWER_ABBREVIATED` → `handleInterviewAnswerAbbreviated`
   - `SYSTEM_COMMAND` → existing STOP/HELP handlers (should be unreachable if step 1 is correct, but keep safe handling)

5. Preserve backward-compatible mode-based routing
   - For session modes not covered by intent-first dispatch, preserve existing mode-based routing behavior.
   - Specifically: an inbound message from a known user in `interviewing` mode must route to the interview engine without running `classifyIntent()` (per Phase 19 verification requirement).

### 2) Update Twilio Inbound To Match Router Order

Update:

- `supabase/functions/twilio-inbound/index.ts`

Requirements:

- Reflect the new router dispatch order.
- Ensure STOP/HELP/system commands bypass intent classification.
- Ensure invite lookup happens before user resolution (as implemented in the router).

---

## Deliverables

- Updated `packages/messaging/conversation-router.ts`
- Updated `supabase/functions/twilio-inbound/index.ts`
- Unit tests:
  - Invitation lookup short-circuit routes correctly
  - STOP/HELP precedence still takes precedence over all intent routing

No migrations. No new env vars.

---

## Unit Tests

### Required Tests

1. Invitation lookup short-circuit

- Scenario: inbound message from unknown number with a pending invitation.
- Expectation: routes to `handleContactInviteResponse` before user resolution runs.

2. STOP/HELP precedence bypass

- Scenario: STOP received from any state.
- Expectation: bypasses intent classifier entirely and routes to system command handlers.

3. Interviewing mode bypass

- Scenario: inbound message from known user in `interviewing` mode.
- Expectation: routes to the interview engine without running `classifyIntent()`.

### Constraints

- Deterministic tests only.
- No network calls.
- Use mocking/stubbing to prove function call ordering:
  - For invite short-circuit: prove user lookup is not called.
  - For STOP/HELP: prove `classifyIntent` is not called.
  - For interviewing mode: prove `classifyIntent` is not called.

---

## Verification

- An inbound message from an unknown number with a pending invitation routes to `handleContactInviteResponse` before user resolution runs.
- An inbound message from a known user in `interviewing` mode routes to the interview engine without running `classifyIntent()`.
- STOP received from any state bypasses the intent classifier entirely.

---

## Acceptance Criteria

- Router dispatch order matches the Requirements section exactly.
- Invite short-circuit is enforced before user resolution.
- STOP/HELP bypass is enforced before intent classification.
- Interviewing mode bypass is preserved (no `classifyIntent()` call).
- Unit tests pass (with the known baseline guardrail test exception only if unchanged from main).
- Lint/typecheck/build pass.
