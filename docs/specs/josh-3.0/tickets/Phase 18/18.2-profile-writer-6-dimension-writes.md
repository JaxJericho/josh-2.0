# Ticket 18.2 — Profile Writer: 6-Dimension Writes (M)

## Role

Principal Full-Stack Engineer (TypeScript, Supabase/Postgres writes, JSONB merge semantics, production-hardening, contract-driven wiring)

## Phase

Phase 18 — 6-Dimension Profile System

## Complexity

M

## What This Ticket Builds

Updates the profile writer so JOSH 3.0 extraction results are persisted in the canonical 3.0 schema shape:

- Writes `CoordinationDimensions` into `profiles.coordination_dimensions` (JSONB)
- Writes 3 coordination signals into the canonical profile columns:
  - `scheduling_availability`
  - `notice_preference`
  - `coordination_style`

This ticket replaces any remaining 2.0 “fingerprint” persistence behavior in the writer path.

## Why It Matters

Phase 18 is a coordinated replace from 2.0 to 3.0. If the writer persists updates in the wrong column, wrong shape, or partial wiring, downstream systems (coverage tracker, interview planner, eligibility, matching) will observe mixed-state profiles and behave unpredictably.

Production readiness here means:

- Correct target columns
- Correct merge rules
- Deterministic writes
- No silent partial application
- Verified via tests that mirror real runtime call paths

## Behavioral Constraints

- No database schema changes.
- No migrations.
- No writes may include any 2.0 factor key names or legacy fingerprint persistence.
- All dimension entries must be persisted as `{ value: number; confidence: number }`.
- Merge must never reduce confidence:
  - `confidence = Math.max(existing.confidence, incoming.confidence)`
- Keep changes scoped to profile writing and directly related unit/integration tests.
- No unrelated refactors or formatting churn.

## Schema Changes

None.

## Runtime Changes

Profile writer persistence logic only (write/merge behavior + correctness checks).

## Dependencies

- Phase 16 schema exists:
  - `profiles.coordination_dimensions` JSONB column
  - profile columns for signals (`scheduling_availability`, `notice_preference`, `coordination_style`)
- Ticket 17.1 exports canonical types in `@josh/db`:
  - `CoordinationDimensions`, `CoordinationSignals`, `DimensionCoverageSummary`
- Ticket 18.1 coverage tracker expects the 3.0 shape and should remain compatible with writer outputs.

## Deliverables

### 1) Update The Writer To Persist 3.0 Shape

Update:

- `packages/core/src/profile/profile-writer.ts`

Requirements:

- Persist dimension updates into `profiles.coordination_dimensions` (JSONB)
- Persist signal updates into their dedicated columns:
  - `profiles.scheduling_availability`
  - `profiles.notice_preference`
  - `profiles.coordination_style`

### 2) Remove 2.0 Persistence Paths

Eliminate any writer behavior that:

- writes to a legacy fingerprint column
- uses legacy factor key sets
- produces a shape not compatible with `CoordinationDimensions`

### 3) Correct Merge Semantics (Production-Safe)

When applying updates:

- For each dimension key:
  - merge by key
  - set `value` to the incoming `value` (latest observation)
  - set `confidence` to `max(existing.confidence, incoming.confidence)`
- Never write malformed entries (missing `value` or `confidence`)
- Ensure `coordination_dimensions` remains an object keyed only by the 6 dimension keys

### 4) Wiring Validation (No “Implemented But Unused”)

Confirm the writer path used in runtime now persists 3.0 updates:

- The function(s) that consume extractor output and call the writer must pass:
  - `coordinationDimensionUpdates` into JSONB writer
  - `coordinationSignalUpdates` into signal column writer
    If there are adapter/shim layers, update them only as needed to maintain correct plumbing.

### 5) Tests That Prove Correct Wiring

Add/Update tests to validate:

- Writer produces correct JSONB shape with only the 6 dimension keys.
- Each written dimension entry includes `{ value, confidence }`.
- Merge does not reduce confidence (incoming lower confidence cannot overwrite higher).
- Signal fields are written to the correct columns.
- A “realistic” write call (closest available to runtime call path) persists both dimensions + signals together.

## Verification Checklist

- `pnpm typecheck` passes
- `pnpm lint` passes
- `pnpm test` passes (excluding any known pre-existing failures on main, if still present — must confirm it fails on main too)
- Guardrail: grep confirms no legacy factor key references remain in the writer path.

Suggested greps:

- `rg -n "FINGERPRINT_FACTOR_KEYS|fingerprintCoveredCount|fingerprint" packages/core/src/profile/profile-writer.ts -S`
- `rg -n "coordination_dimensions" packages/core/src/profile/profile-writer.ts -S`

## Completion Criteria

Ticket is complete when:

- `profile-writer.ts` persists only the 3.0 coordination model:
  - JSONB writes go to `profiles.coordination_dimensions`
  - Signal writes go to their dedicated columns
- Confidence merge never decreases confidence.
- Tests demonstrate correct shape + correct column wiring.
- Changes are committed and pushed on:
  - `ticket/18.2-profile-writer-6-dimension-writes`
- Final summary lists EVERY created/changed file with FULL repo-relative paths.
