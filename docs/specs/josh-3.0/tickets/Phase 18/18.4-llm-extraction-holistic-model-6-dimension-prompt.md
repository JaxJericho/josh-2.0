# Ticket 18.4 — LLM Extraction: Holistic Model + 6-Dimension Prompt (L)

## Role

Principal LLM Systems Engineer (TypeScript, schema-first LLM I/O, retries/timeouts, interview engine integration)

## Phase

Phase 18 — 6-Dimension Profile System

## Complexity

L

## What This Ticket Builds

Replaces the legacy per-step interview extraction prompt + extractor with a holistic extraction system that:

- Reads full conversation history (multi-turn)
- Produces JSON-only output matching `HolisticExtractOutput`
- Updates 6 coordination dimensions + 3 coordination signals
- Provides a complete 9-key coverage summary
- Enforces strict schema validation and safe fallback behavior

## Why It Matters

Phase 18 requires the system to extract and persist the 6-dimension model reliably. Any malformed LLM output, legacy 2.0 factor key leakage, or non-deterministic “step-based” extraction undermines production stability. This ticket makes extraction:

- schema-bound,
- replay-safe at runtime (discard invalid results),
- and resilient (timeout + retry) without corrupting profiles.

## Behavioral Constraints

- No database schema changes.
- No migrations.
- No 2.0 factor names may appear anywhere in the extraction system (prompt, schemas, extractor, tests).
- LLM outputs must be validated; invalid outputs must not modify the existing profile.
- Keep changes tightly scoped to:
  - `packages/llm` (prompt/extractor/schema/tests)
  - `packages/core/src/interview/state.ts` (wiring call site)
  - `packages/db` (type deletion only as required)
- Preserve existing fallback behavior (do not introduce new routing or interview flow logic).

## Schema Changes

None.

## Runtime Changes

Yes (LLM extraction call path + validation + retry/timeout behavior), but scoped strictly to extraction and its caller(s).

## Dependencies

- Ticket 17.1: holistic types exist in `@josh/db` (`HolisticExtractInput`, `HolisticExtractOutput`).
- Ticket 17.2: `packages/llm` holistic extractor scaffolding exists (if present) and must be aligned to this ticket’s requirements.
- Ticket 18.1/18.2: downstream expects 6-dimension model writes/reads.

## Deliverables

### 1) Replace The System Prompt

Replace:

- `packages/llm/src/prompts/interview-extraction-system-prompt.ts`

With a holistic prompt that:

- Reads full conversation history (not a single step)
- Returns only valid JSON matching `HolisticExtractOutput`
- Uses `coordinationDimensionUpdates` keyed by the 6 dimension names
- Includes `coverageSummary` with confidence per dimension and per signal
- Never returns 2.0 factor names in any field
- Sets `needsFollowUp: true` only when a required dimension cannot be inferred from conversation history

### 2) Replace The Extractor API

Replace:

- `extractInterviewSignals(input: InterviewExtractInput)`

With:

- `extractCoordinationSignals(input: HolisticExtractInput): Promise<HolisticExtractOutput>`

### 3) Wire Interview State To Holistic Extraction

Update:

- `packages/core/src/interview/state.ts`

So it calls `extractCoordinationSignals()` with full conversation history at natural pause points.

### 4) Enforce Schema Validation On Every LLM Response

- JSON schema validation must run on every LLM response.
- Invalid responses must be discarded.
- When discarded, the existing profile must remain unchanged and the interview must continue.

### 5) Timeout + Retry Policy

- LLM timeout: 5 seconds
- Single retry on transient failure
- Preserve existing fallback behavior:
  - On final failure/timeout: existing profile unchanged; interview continues.

### 6) Delete Deprecated InterviewExtract Types (packages/db)

Delete:

- `InterviewExtractInput`
- `InterviewExtractOutput`

These were previously deprecated and must now be removed. Ensure no remaining imports/usage exist across the repo.

### 7) Tests

Add/update tests to cover:

- Valid holistic extraction path produces a valid `HolisticExtractOutput`
- Invalid JSON / invalid schema output triggers discard + profile unchanged fallback
- Timeout triggers fallback and interview continues
- Golden tests: multi-turn conversations produce correct dimension updates

## Verification Checklist

Repo-wide:

- `pnpm lint` passes
- `pnpm typecheck` passes
- `pnpm build` passes
- `pnpm test` passes (excluding any known pre-existing failures on main; if present, confirm on main too)

Behavioral verification (must be test-backed where possible):

- A 5-message conversation about outdoor activities produces `adventure_orientation >= 0.65` in `coordinationDimensionUpdates`
- Any LLM response containing any 2.0 factor key fails schema validation and is discarded
- Every valid response contains `coverageSummary` entries for all 9 keys (6 dimensions + 3 signals)
- LLM timeout → existing profile unchanged → interview continues
- No references remain to `fingerprintPatches` or any 2.0 factor name anywhere in the extraction system

## Completion Criteria

Ticket is complete when:

- Holistic prompt + extractor replace the per-step system fully.
- `state.ts` uses full conversation history and calls `extractCoordinationSignals()` at pause points.
- Schema validation is enforced with discard + unchanged-profile fallback.
- Timeout + retry behavior meets the 5s + single retry requirement and preserves fallback semantics.
- `InterviewExtractInput/Output` types are deleted and repo typecheck passes.
- Tests cover valid/invalid/timeout paths + golden multi-turn behavior.
- Changes are committed and pushed on:
  - `ticket/18.4-llm-extraction-holistic-model-6-dimension-prompt`
- Final summary lists EVERY created/changed file with FULL repo-relative paths.
