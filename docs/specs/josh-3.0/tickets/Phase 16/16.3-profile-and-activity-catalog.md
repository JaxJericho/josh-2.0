# Ticket 16.3 — Profile Schema And activity_catalog Updates

## Role

Principal Database Engineer

## Phase

Phase 16 — Schema Foundation

## Complexity

S

---

## What This Ticket Builds

This ticket expands the schema to support the 3.0 coordination model by:

- Adding new coordination signal columns to `profiles`
- Adding `registration_source` to `users`
- Creating the `activity_catalog` table

This ticket introduces no runtime logic changes. It is purely additive schema expansion.

---

## Why It Matters

These schema additions enable:

- 6-dimension coordination model storage
- Layer B profile expansion (future capability, not used at MVP)
- Solo coordination activity suggestions
- Activity catalog–driven matching and plan generation

Without these changes, Phase 18 (6-dimension system) and Phase 19 (Solo + Plan Circle flows) cannot proceed.

---

## Behavioral Constraints

- Fully additive migration only.
- No modification or removal of existing columns.
- No renames.
- No destructive operations.
- Layer B columns must be nullable and unused at MVP.
- `activity_catalog` must enforce uniqueness on `activity_key`.
- Replay-safe migration required.

---

## Dependencies

### Must Be Complete Before This Ticket Runs

- Ticket 16.1 — Additive enum migrations
- Ticket 16.2 — New 3.0 tables

### What This Ticket Produces For Downstream Tickets

- New coordination signal columns → consumed by Phase 18 profile writer
- `activity_catalog` → consumed by Solo coordination engine and Plan generation logic
- `registration_source` → consumed by onboarding analytics and invite flow

---

## Schema Changes

### 1. Add Columns To `profiles`

Add the following nullable columns:

- `scheduling_availability` jsonb
- `notice_preference` text
- `coordination_style` text

Layer B placeholders (nullable, not used at MVP):

- `personality_substrate` jsonb
- `relational_style` jsonb
- `values_orientation` jsonb

No default values required. All nullable.

---

### 2. Add Column To `users`

Add:

- `registration_source` text nullable

No default required.

---

### 3. Create `activity_catalog` Table

Columns:

- `id` uuid primary key default gen_random_uuid()
- `activity_key` text not null unique
- `display_name` text not null
- `category` text not null
- `short_description` text not null
- `regional_availability` text not null
- `motive_weights` jsonb not null
- `constraints` jsonb not null
- `preferred_windows` text[] not null
- `group_size_fit` text[] not null
- `tags` text[]
- `created_at` timestamptz not null default now()

Constraints:

- Unique constraint on `activity_key`
- No foreign keys required

---

## Deliverables

- Migration file:
  - `supabase/migrations/YYYYMMDDHHMMSS_ticket_16_3_profile_and_activity_catalog.sql`

- Seed script:
  - `scripts/seed-activity-catalog.ts`
    (inserts 55 canonical activity entries after migration)

---

## Verification Checklist

After migration:

1. New columns exist on `profiles`.
2. `registration_source` exists on `users`.
3. `activity_catalog` table exists.
4. Unique constraint on `activity_key` enforced.
5. Migration replays cleanly via `supabase db reset --no-seed`.
6. `pnpm typecheck`, `pnpm lint`, `pnpm test`, `pnpm build` all pass.

---

## Completion Criteria

This ticket is complete when:

- Migration merged to main
- Migration applied to staging
- Schema verified in staging
- Replay confirmed idempotent
- Seed script successfully inserts 55 activities
