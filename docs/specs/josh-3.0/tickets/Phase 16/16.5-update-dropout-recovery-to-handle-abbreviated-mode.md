# Role

Principal Systems Architect & Full-Stack Engineer (Supabase/Postgres, replay-safe migrations, staged verification)

# Phase

Phase 16 — Schema Foundation

# Complexity

S

# What This Ticket Builds

Dropout recovery parity for abbreviated interviews by updating the dropout recovery SQL function to treat:

- `interviewing`
- `interviewing_abbreviated`
  as equivalent for MVP.

# Why It Matters

JOSH 3.0 introduces an abbreviated interview mode for invited users. If dropout recovery only targets `interviewing`, users in `interviewing_abbreviated` will not receive the same recovery nudges and will effectively “fall out” of onboarding reliability. This ticket preserves behavioral continuity and reduces silent churn.

# Behavioral Constraints

- This is a function-level change only.
- No routing refactors.
- No engine refactors.
- No timing changes.
- No idempotency changes.
- No additional filters.
- No formatting churn that risks accidental logic diffs.
- Existing migration history must remain untouched.

# Schema Changes

None (no new tables/columns/indexes). This is a **SQL function replacement** delivered via an additive migration.

# Dependencies

- Existing function source of truth:
  - `supabase/migrations/20260218170000_ticket_8_6_interview_dropout_recovery.sql`
- Function to replace:
  - `public.enqueue_interview_dropout_nudges`

# Deliverables

1. One new additive migration file:
   - `supabase/migrations/YYYYMMDDHHMMSS_ticket_16_5_dropout_recovery_abbrev_mode.sql`
2. The migration must:
   - `create or replace function public.enqueue_interview_dropout_nudges(...) ...`
   - Copy the full existing function definition exactly as-is
   - Change only the mode predicate described below
3. Local replay verification passes.
4. Staging push and explicit SQL verification completed.

# Exact Required Change

In the function body, expand the mode predicate from:

```sql
where cs.mode = 'interviewing'::public.conversation_mode

to:

where cs.mode in (
  'interviewing'::public.conversation_mode,
  'interviewing_abbreviated'::public.conversation_mode
)

No other logic changes are permitted.

Verification Checklist
Local Replay Test (Required)

Run:

supabase db reset --no-seed

This must succeed. If it fails, the migration is invalid and must be fixed before proceeding.

Local Function Definition Check (Required)

Confirm the function definition contains interviewing_abbreviated:

select pg_get_functiondef('public.enqueue_interview_dropout_nudges()'::regprocedure);
Staging Push (Required)

Run:

supabase db push --linked

Apply the migration.

Staging Verification (Required)

In Supabase SQL editor, confirm the deployed function contains interviewing_abbreviated:

select pg_get_functiondef('public.enqueue_interview_dropout_nudges()'::regprocedure);
Completion Criteria

This ticket is complete when:

A single additive migration replaces public.enqueue_interview_dropout_nudges with the expanded mode predicate.

Local replay (supabase db reset --no-seed) succeeds.

Staging push is applied.

Staging SQL verification confirms the predicate includes both interviewing and interviewing_abbreviated.

Changes are committed and pushed on a branch named:

ticket/16.5-dropout-abbrev-mode
```
