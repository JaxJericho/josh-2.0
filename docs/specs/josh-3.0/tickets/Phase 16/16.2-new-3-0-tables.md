# Ticket 16.2 — New Tables: contact_invitations, contact_circle, plan_briefs

## Role

Principal Database Engineer

## Phase

Phase 16 — Schema Foundation

## Complexity

M

---

## What This Ticket Builds

This ticket introduces the structural database foundation required for the JOSH 3.0 invited-user and Plan Circle flows.

It creates three new tables:

- `plan_briefs`
- `contact_invitations`
- `contact_circle`

These tables support:

- Named-contact coordination (Plan Circle)
- Invited user onboarding
- Plan-level invitation tracking
- Future LinkUp expansion paths

This ticket is **purely additive**. No runtime behavior changes are introduced.

---

## Why It Matters

These tables establish the relational domain for Path 2 (Plan Circle) and the invited-user flow.

Without this foundation:

- Invited-user onboarding cannot persist state
- Named plan coordination cannot exist
- Contact circles cannot be stored
- Phase 19 and 20 work cannot proceed

This ticket must be complete and structurally correct before any routing or messaging logic is implemented.

---

## Behavioral Constraints

- All migrations must be fully additive.
- No existing tables, columns, or enums may be modified.
- No cascading deletes unless explicitly required.
- All foreign keys must reference existing primary keys.
- All new tables must include `created_at` and `updated_at` timestamps.
- Replay safety is mandatory — migration must use `IF NOT EXISTS` where applicable.
- Indexes must be explicit and intentional.
- No runtime code changes in this ticket.

---

## Dependencies

### Must Be Complete Before This Ticket Runs

- Ticket 16.1 — Additive Enum Migrations
  - `complete_invited` must exist on `profile_state`
  - 3.0 `conversation_mode` enum values must exist
  - New `learning_signal_type` enum values must exist

### What This Ticket Produces For Downstream Tickets

- `plan_briefs` table → consumed by:
  - Named plan request handler (Phase 19)
  - Invite orchestration engine
- `contact_invitations` table → consumed by:
  - SMS routing layer
  - Invite response handler
- `contact_circle` table → consumed by:
  - Plan Circle coordination flow
  - Dashboard contact management

---

## Tables To Be Created

### 1. plan_briefs

Represents a structured coordination intent created by a user.

Columns:

- `id` uuid primary key
- `creator_user_id` uuid references `users(id)` not null
- `activity_key` text
- `proposed_time_window` text
- `notes` text
- `status` text not null default 'draft'
- `created_at` timestamptz not null default now()
- `updated_at` timestamptz not null default now()

Constraints:

- Foreign key: `creator_user_id → users(id)`
- No cascade delete

---

### 2. contact_invitations

Represents an invitation sent from a JOSH member to a contact.

Columns:

- `id` uuid primary key
- `inviter_user_id` uuid references `users(id)` not null
- `invitee_phone_hash` text not null
- `plan_brief_id` uuid references `plan_briefs(id)` nullable
- `status` text not null default 'pending'
  - allowed values: pending, accepted, declined, expired
- `created_at` timestamptz not null default now()
- `updated_at` timestamptz not null default now()

Indexes:

- Index on `invitee_phone_hash`
- Index on `inviter_user_id`

Constraints:

- Foreign key: `inviter_user_id → users(id)`
- Foreign key: `plan_brief_id → plan_briefs(id)`
- No cascade delete

---

### 3. contact_circle

Represents named contacts stored by a user for Plan Circle coordination.

Columns:

- `id` uuid primary key
- `user_id` uuid references `users(id)` not null
- `contact_name` text not null
- `contact_phone_hash` text not null
- `contact_phone_e164` text not null
- `created_at` timestamptz not null default now()
- `updated_at` timestamptz not null default now()

Constraints:

- Unique constraint on (`user_id`, `contact_phone_hash`)
- Foreign key: `user_id → users(id)`
- Index on `user_id`

---

## Deliverables

- Migration file:
  - `supabase/migrations/YYYYMMDDHHMMSS_ticket_16_2_new_3_0_tables.sql`

No runtime code changes.

---

## Verification Checklist

After migration:

1. All three tables exist.
2. Foreign keys resolve successfully.
3. Index on `invitee_phone_hash` is used by EXPLAIN ANALYZE.
4. Unique constraint on (`user_id`, `contact_phone_hash`) is enforced.
5. Migration replays cleanly via:
   - `supabase db reset --no-seed`
6. `pnpm typecheck`, `pnpm lint`, `pnpm test`, `pnpm build` all pass.

---

## Completion Criteria

This ticket is complete when:

- Migration is merged to main
- Migration applied to staging
- Tables verified via SQL inspection
- Replay confirmed idempotent
- No unintended schema modifications occurred
