# Ticket 17.1 — 3.0 Type Definitions (packages/db) (M)

## Role

Principal Systems Architect & Full-Stack Engineer (TypeScript monorepo, domain contracts, Supabase/Postgres schema typing)

## Phase

Phase 17 — Type System And Eligibility Layer

## Complexity

M

## What This Ticket Builds

Adds the canonical JOSH 3.0 type definitions to `packages/db` and introduces holistic extraction types so downstream Phase 17+ runtime work can rely on a single, schema-aligned contract layer.

## Why It Matters

Phase 17 refactors depend on stable domain contracts. Without a centralized type boundary, types drift across packages, schema assumptions fragment, and later runtime refactors become brittle and expensive. This ticket establishes `packages/db` as the authoritative type source for JOSH 3.0 domain entities and extraction contracts.

## Behavioral Constraints

- No database schema changes.
- No Supabase migrations.
- No runtime behavior changes. Any edits outside `packages/db` must be strictly limited to resolving TypeScript import/type errors caused by new exports.
- No broad refactors or formatting churn.
- Additive changes only. Deprecate legacy types but do not delete them in this ticket.

## Schema Changes

None.

## Runtime Changes

None intended.

## Dependencies

- Phase 16 schema foundation is complete and is the source of truth for table shapes:
  - `plan_briefs`
  - `contact_invitations`
  - `contact_circle`
  - `activity_catalog`
- Profile coordination fields exist from Phase 16 and inform typed interfaces:
  - `scheduling_availability`
  - `notice_preference`
  - `coordination_style`
  - `coordination_dimensions` shadow JSON column
- Activity catalog seed source of truth:
  - `docs/seed/activity_catalog_seed.ts` (shape consistency requirement)

## Deliverables

### 1) Add New Domain Types (packages/db)

Add the following files under:

`packages/db/src/types/`

#### a) Table-Shape Types

- `contact-invitation.ts`
  - Export: `ContactInvitation`
  - Must match `contact_invitations` table shape.
- `plan-brief.ts`
  - Export: `PlanBrief`
  - Must match `plan_briefs` table shape.
- `contact-circle.ts`
  - Export: `ContactCircleEntry`
  - Must match `contact_circle` table shape.
- `activity-catalog.ts`
  - Export: `ActivityCatalogEntry`
  - Must be consistent with `docs/seed/activity_catalog_seed.ts`.

#### b) Coordination Model Types

- `coordination-dimensions.ts`
  - Export: `CoordinationDimensionValue` (shape: `{ value: number; confidence: number }`)
  - Export: `CoordinationDimensions`
  - Must constrain exactly these 6 keys:
    - `social_energy`
    - `social_pace`
    - `conversation_depth`
    - `adventure_orientation`
    - `group_dynamic`
    - `values_proximity`
- `coordination-signals.ts`
  - Export: `CoordinationSignals`
  - Typed interface for:
    - `scheduling_availability`
    - `notice_preference`
    - `coordination_style`
- `dimension-coverage-summary.ts`
  - Export: `DimensionCoverageSummary`
  - Must include:
    - Per-dimension `{ covered: boolean; confidence: number }` for all 6 dimensions
    - Per-signal `{ covered: boolean; confidence: number }` for all 3 signals

### 2) Add Holistic Extraction Types

Create:

`packages/db/src/types/holistic-extraction.ts`

Exports:

- `HolisticExtractInput`
  - Fields:
    - `conversationHistory: ConversationTurn[]`
    - `currentProfile: Partial<CoordinationDimensions>`
    - `sessionId: string`
  - Must NOT include `stepId`.
- `HolisticExtractOutput`
  - Fields:
    - `coordinationDimensionUpdates`
    - `coordinationSignalUpdates`
    - `coverageSummary: DimensionCoverageSummary`
    - `needsFollowUp: boolean`

### 3) Deprecate Legacy Extraction Types (Do Not Delete)

Locate existing:

- `InterviewExtractInput`
- `InterviewExtractOutput`

Mark them as `@deprecated` and point to the holistic types. Do not remove them in this ticket.

### 4) Export Surface

Ensure all new types are exported through the public `packages/db` entrypoints used by the monorepo (whatever export pattern the repo currently uses).

### 5) Unit Test

Add a unit test that imports and instantiates (or type-checks) all newly added types without error.

## Verification Checklist

- `pnpm typecheck` passes across all packages.
- `CoordinationDimensions` constrains exactly the 6 dimension keys listed above.
- `HolisticExtractInput` does not accept a `stepId` field.
- Unit test added for type imports/instantiation passes.

## Completion Criteria

This ticket is complete when:

- All required type files exist under `packages/db/src/types/` and exports are wired.
- Holistic extraction types exist and are exported.
- Legacy extraction types are marked `@deprecated` (not deleted).
- `pnpm typecheck` passes repo-wide.
- The new unit test passes.
- Changes are committed and pushed on branch:
  - `ticket/17.1-3.0-type-definitions-packages-db`
- Final summary lists EVERY created/changed file with FULL repo-relative paths.
